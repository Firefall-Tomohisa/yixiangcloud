一、RSYNC
1、安装：

yum install xinetd -y

vim /etc/xinetd.d/rsync
 
disable = no

2、配置

vim /etc/rsyncd.conf

uid = nobody
gid = nobody
use chroot = yes
address = 192.168.136.128
port 873
log file = /var/log/rsyncd.log
pid file = /var/run/rsyncd.pid
hosts allow = 192.168.136.0/24
[wwwroot]
    path = /var/www/html
    comment = Document Root of www.gateway.com
    read only = yes
    dont compress = *.gz *.bz2 *.tgz *.zip *.rar *.z
    auth users = baker
    secrets file = /etc/rsyncd_users.db

vim /etc/rsyncd_users.db
baker:123456

chmod 600 /etc/rsyncd_users.db

启动服务（服务端）

/usr/bin/rsync --daemon

systemctl start xinetd


3、客户端同步

rsync -avzH --delete baker@192.168.136.128::wwwroot /opt

无交互式认证

vim /etc/rsyncpasswd
123456

chmod 600 /etc/rsyncpasswd

rsync -avzH --delete --password-file=/etc/rsyncpasswd baker@192.168.136.128::wwwroot /opt


二、SSH+RSYNC


1、下行同步

rsync -avzH --delete sshuser@192.168.136.128:/var/www/html/* /var/www/html


2、上行同步

setfacl -R -m u:sshuser:rwx /var/www/html

rsync -avzH --delete /var/www/html/* sshuser@192.168.100.1:/var/www/html



三、rsync+inotify实时同步

1、修改内核配置文件

vim /etc/sysctl.conf

fs.inotify.max_queued_events = 16384
fs.inotify.max_user_instances = 1024
fs.inotify.max_user_watches = 1048576

max_queue_events：监控队列大小
max_user_instances：最多监控实例数
max_user_watches：每个实例最多监控文件数



sysctl -p

2、编译安装inotify

yum install gcc -y

tar zxcf inotify-tools-3.14.tar.gz

./configure&&make&&ake install


3、运行脚本

inotifywait：用于持续监控，实时输出结果
inotifywatch：用于短期监控，任务完成后再出结果


-m，持续进行监控
-r，递归监控所有子对象
-q，简化输出信息
-e，指定要监控哪些事件类型



#!/bin/bash
INOTIFY_CMD="inotifywait -mrq -e modify,create,attrib,move,delete /var/www/html/"
RSYNC_CMD="rsync -azH --delete /var/www/html/ put@192.168.200.1:/var/www/html"

$INOTIFY_CMD | while read DIRECTORY EVENT FILE

do
    if [ $(pgrep rsync | wc -l) -le 0 ] ;
    then  $RSYNC_CMD
    fi
done


